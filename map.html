<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blind Map Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script id="quiz-data-script"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    #map { height: 100vh; }
    .info-box {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      z-index: 1000;
      border: 1px solid #ccc;
      font-family: sans-serif;
    }
    .stats-box {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 8px 12px;
      z-index: 1000;
      border: 1px solid #ccc;
      font-family: sans-serif;
      text-align: right;
    }
    .next-btn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 12px 24px;
      font-size: 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: none;
      font-family: sans-serif;
    }
    .next-btn:hover {
      background: #45a049;
    }
    .game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
      background: white;
      padding: 30px;
      border: 2px solid #ccc;
      border-radius: 8px;
      text-align: center;
      font-family: sans-serif;
      display: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .game-over h2 {
      margin-top: 0;
      color: #333;
    }
    .restart-btn {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .restart-btn:hover {
      background: #0b7dda;
    }
    .back-btn {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 8px 16px;
      font-size: 14px;
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-family: sans-serif;
      text-decoration: none;
      display: inline-block;
    }
    .back-btn:hover {
      background: #e0e0e0;
    }
    .quiz-title {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 8px 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: sans-serif;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">‚Üê Back to Quizzes</a>
  <div class="quiz-title" id="quiz-title">Quiz</div>
  <div id="map"></div>
  <div class="info-box" id="info">Guess the location: <strong>Loading...</strong></div>
  <div class="stats-box" id="stats">
    <div>Round: <strong id="round">1</strong> / <strong id="total-rounds">10</strong></div>
    <div>Score: <strong id="score">0</strong></div>
  </div>
  <button class="next-btn" id="next-btn">Next Round</button>
  <div class="game-over" id="game-over">
    <h2>Game Over!</h2>
    <p>Final Score: <strong id="final-score">0</strong></p>
    <p id="average-distance"></p>
    <button class="restart-btn" onclick="location.reload()">Play Again</button>
    <a href="index.html" class="restart-btn" style="display: inline-block; margin-left: 10px; background: #6c757d;">Choose Another Quiz</a>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ========== GET QUIZ FROM URL ==========
    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get('quiz') || 'world-capitals';

    // ========== LOAD QUIZ DATA ==========
    let TOTAL_ROUNDS = 10;
    let locations = [];

    // Load the quiz data file
    const script = document.getElementById('quiz-data-script');
    script.src = `quizzes/${quizId}.js`;
    script.onload = function() {
      if (!window.QUIZ_DATA) {
        alert('Quiz not found! Redirecting to home...');
        window.location.href = 'index.html';
        return;
      }

      // Set quiz data
      locations = window.QUIZ_DATA.locations;
      TOTAL_ROUNDS = window.QUIZ_DATA.totalRounds;
      document.getElementById('quiz-title').textContent = window.QUIZ_DATA.title;
      document.title = `Blind Map Quiz - ${window.QUIZ_DATA.title}`;

      // Start the game
      initializeGame();
    };

    script.onerror = function() {
      alert('Failed to load quiz! Redirecting to home...');
      window.location.href = 'index.html';
    };

    // ========== SETUP ==========
    const map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
      attribution: '',
    }).addTo(map);

    // ========== GAME STATE ==========
    let currentRound = 0;
    let score = 0;
    let totalDistance = 0;
    let hasGuessed = false;
    let currentLocation = null;
    let markers = [];
    let lines = [];
    let gameLocations = [];

    // ========== CLICK HANDLER ==========
    map.on('click', function(e) {
      if (hasGuessed || !currentLocation) return;

      const userLat = e.latlng.lat;
      const userLng = e.latlng.lng;

      const distance = getDistanceFromLatLonInKm(userLat, userLng, currentLocation.lat, currentLocation.lng);
      totalDistance += distance;

      // Calculate score based on distance (max 1000 points per round)
      // Perfect guess (0 km) = 1000 points, decreases as distance increases
      const roundScore = Math.max(0, Math.floor(1000 - (distance / 20)));
      score += roundScore;

      // Add user marker
      const userMarker = L.marker([userLat, userLng], { title: "Your Guess" }).addTo(map);
      markers.push(userMarker);

      // Add correct marker
      const correctMarker = L.marker([currentLocation.lat, currentLocation.lng], {
        title: "Correct Location",
        icon: L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        })
      }).addTo(map);
      markers.push(correctMarker);

      // Draw line between guess and correct
      const line = L.polyline([
        [userLat, userLng],
        [currentLocation.lat, currentLocation.lng]
      ], { color: 'red' }).addTo(map);
      lines.push(line);

      // Feedback
      const infoBox = document.getElementById('info');
      infoBox.innerHTML = `You guessed ${distance.toFixed(1)} km away. +${roundScore} points!`;

      // Update score display
      document.getElementById('score').textContent = score;

      // Show next button
      document.getElementById('next-btn').style.display = 'block';

      hasGuessed = true;
    });

    // ========== ROUND MANAGEMENT ==========
    function startNewRound() {
      if (currentRound >= TOTAL_ROUNDS) {
        endGame();
        return;
      }

      hasGuessed = false;
      currentLocation = gameLocations[currentRound];
      currentRound++;

      // Clear previous markers and lines
      markers.forEach(marker => map.removeLayer(marker));
      lines.forEach(line => map.removeLayer(line));
      markers = [];
      lines = [];

      // Reset map view
      map.setView([20, 0], 2);

      // Update UI
      document.getElementById('info').innerHTML = `Guess the location: <strong>${currentLocation.name}</strong>`;
      document.getElementById('round').textContent = currentRound;
      document.getElementById('total-rounds').textContent = TOTAL_ROUNDS;
      document.getElementById('next-btn').style.display = 'none';
    }

    function endGame() {
      const avgDistance = (totalDistance / TOTAL_ROUNDS).toFixed(1);

      document.getElementById('final-score').textContent = score;
      document.getElementById('average-distance').textContent = `Average distance: ${avgDistance} km`;
      document.getElementById('game-over').style.display = 'block';
      document.getElementById('next-btn').style.display = 'none';
    }

    // ========== HELPER FUNCTIONS ==========
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of Earth in km
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById('next-btn').addEventListener('click', startNewRound);

    // ========== INITIALIZE GAME ==========
    function initializeGame() {
      // Shuffle and select locations for this game
      gameLocations = shuffleArray([...locations]).slice(0, TOTAL_ROUNDS);
      startNewRound();
    }
  </script>
</body>
</html>

